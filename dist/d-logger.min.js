import e from"moment";import n from"node-emojify";import t from"fs";import{join as r}from"path";function o(e,n){if(!(e instanceof n))throw new TypeError("Cannot call a class as a function")}function i(e,n){for(var t=0;t<n.length;t++){var r=n[t];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function c(e,n,t){return n&&i(e.prototype,n),t&&i(e,t),Object.defineProperty(e,"prototype",{writable:!1}),e}function l(e,n,t){return n in e?Object.defineProperty(e,n,{value:t,enumerable:!0,configurable:!0,writable:!0}):e[n]=t,e}function u(e,n){return u=Object.setPrototypeOf?Object.setPrototypeOf.bind():function(e,n){return e.__proto__=n,e},u(e,n)}function f(e,n){if("function"!=typeof n&&null!==n)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(n&&n.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),n&&u(e,n)}function a(e){return a="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},a(e)}function s(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function g(e,n){if(n&&("object"===a(n)||"function"==typeof n))return n;if(void 0!==n)throw new TypeError("Derived constructors may only return object or undefined");return s(e)}function p(e){return p=Object.setPrototypeOf?Object.getPrototypeOf.bind():function(e){return e.__proto__||Object.getPrototypeOf(e)},p(e)}var h,v,d,y={emerg:"emerg",alert:"alert",crit:"crit",error:"error",warn:"warn",warning:"warning",notice:"notice",info:"info",debug:"debug"},m=(l(h={},y.emerg,console.trace),l(h,y.alert,console.trace),l(h,y.crit,console.trace),l(h,y.error,console.error),l(h,y.warn,console.warn),l(h,y.warning,console.warning),l(h,y.notice,console.info),l(h,y.info,console.info),l(h,y.debug,console.debug),h),b=(l(v={},y.emerg,"red"),l(v,y.alert,"orange"),l(v,y.crit,"red"),l(v,y.error,"red"),l(v,y.warn,"yellow"),l(v,y.warning,"yellow"),l(v,y.notice,"blue"),l(v,y.info,"green"),l(v,y.debug,"rainbow"),v),w=(l(d={},y.emerg,0),l(d,y.alert,1),l(d,y.crit,2),l(d,y.error,3),l(d,y.warn,4),l(d,y.warning,4),l(d,y.notice,5),l(d,y.info,6),l(d,y.debug,7),d);function _(e,n){(null==n||n>e.length)&&(n=e.length);for(var t=0,r=new Array(n);t<n;t++)r[t]=e[t];return r}function O(e,n){return function(e){if(Array.isArray(e))return e}(e)||function(e,n){var t=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=t){var r,o,i=[],c=!0,l=!1;try{for(t=t.call(e);!(c=(r=t.next()).done)&&(i.push(r.value),!n||i.length!==n);c=!0);}catch(e){l=!0,o=e}finally{try{c||null==t.return||t.return()}finally{if(l)throw o}}return i}}(e,n)||function(e,n){if(e){if("string"==typeof e)return _(e,n);var t=Object.prototype.toString.call(e).slice(8,-1);return"Object"===t&&e.constructor&&(t=e.constructor.name),"Map"===t||"Set"===t?Array.from(e):"Arguments"===t||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(t)?_(e,n):void 0}}(e,n)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function k(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:1;try{throw new Error("Log stack")}catch(t){try{var n=t.stack.split("\n").map((function(e){return e.trim()})).filter((function(e){return e.startsWith("at")}));return String(n[e]).slice(3)}catch(e){return""}}}function P(e){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(!n)return e;var t=e.replaceAll(/[()]/g,"").split("///").pop();return t.includes("!./")&&(t=t.split("!./").pop()),t}var E=function(n){return function(t){var r=t.date;return e(r).format(n)}},S=function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];return function(n){return P(n.location,e)}},A=function(){return function(e){return e.message}},L=function(e){return function(){return n(e)}},F=function(){return function(e){return e.level.toUpperCase()}},j=function(n){return function(t){var r=t.level,o=t.date;return"".concat(e(o).format(n)," | ").concat(r.toUpperCase())}},R=function(){return function(){return"\n"}};function M(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return function(e){return n.reduce((function(n,t){return"".concat(n).concat(t(e))}),"")}}function C(e,n){return w[e]<=w[n]}function I(e){return null==e?e:e?e.length:0}function Y(e,n){return"".concat(n,":").concat(I(e))}function x(e){if(!e)return e;for(var n=JSON.parse(JSON.stringify(e)),t=arguments.length,r=new Array(t>1?t-1:0),o=1;o<t;o++)r[o-1]=arguments[o];return r.forEach((function(e){for(var t=n,r=e,o=e.split("."),i=o.length;i<0;i-=1){var c=o[o.length-i];i>1&&(t=t[c]),r=c}t[r]=Y(t[r],r)})),n}function D(e,n){var t=e;return Object.entries(n).forEach((function(e){var n=O(e,2),r=n[0],o=n[1];o&&(t[r]=o)})),t}function G(){return{format:function(e){return"function"==typeof(n=e)&&(n=n()),function(e){return!!(e&&e.stack&&e.message)}(n)?n.toString():"object"===a(n)||Array.isArray(n)?JSON.stringify(n):String(n);var n},level:y.info,template:function(e){return e}}}var U=c((function e(n,t,r,i){o(this,e),l(this,"level",null),l(this,"message",null),l(this,"date",null),l(this,"location",null),this.level=n,this.message=t,this.date=r,this.location=i})),V=function(){function e(n){o(this,e),l(this,"config",null),this.config=D(G(),n)}return c(e,[{key:"isAllowed",value:function(e){return C(e,this.config.level)}},{key:"format",value:function(e){return this.config.format(e)}},{key:"getMessage",value:function(e){return this.config.template(e)}},{key:"creatingMessage",value:function(e){var n=this,t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(t||(t=this.config.level),r||(r=this.config.stepInStack),!this.isAllowed(t)||!e)return null;var o=e.reduce((function(e,t){return"".concat(e," ").concat(n.format(t))}),"");return this.getMessage(new U(t,o,new Date,k(r)))}},{key:"log",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return this.creatingMessage(e,n,t)}}]),e}();function W(e){var n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var t,r=p(e);if(n){var o=p(this).constructor;t=Reflect.construct(r,arguments,o)}else t=r.apply(this,arguments);return g(this,t)}}var T=function(e){f(t,V);var n=W(t);function t(e){o(this,t);var r=D({level:"info",colorize:!0,template:M(j("DD.MM.YYYY HH:mm:ss"),R(),S(),R(),A()),stepInStack:5},e);return n.call(this,r)}return c(t,[{key:"__getConsoleMethod",value:function(e){if(e in m){var n=m[e];if(n)return n}return console.log}},{key:"log",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=this.creatingMessage(e,n,t);if(!r)return null;var o=this.__getConsoleMethod(n);return this.config.colorize?o("%c".concat(r,"\n"),"color: ".concat(b[n])):o("".concat(r,"\n")),r}}]),t}();function B(e){var n=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var t,r=p(e);if(n){var o=p(this).constructor;t=Reflect.construct(r,arguments,o)}else t=r.apply(this,arguments);return g(this,t)}}var H=function(n){f(u,V);var i=B(u);function u(n){var t;o(this,u);var c=D({level:"info",directory:null,filePrefix:process.env.VUE_APP_LOG_FILE_PREFIX||"app",numberOfFiles:process.env.VUE_APP_LOG_FILE_COUNT||5,isRotatingFiles:!1,template:M(F(),L(" - "),E("DD.MM.YYYY HH:mm:ss"),L(" - "),S(!0),R(),A(),R()),stepInStack:5},n);return l(s(t=i.call(this,c)),"__fileStream",null),t.config.path=r(n.directory,"".concat(n.filePrefix,".").concat(e().format("YYYY-MM-DD"),".log")),t.initCurrentLogFile().finally((function(){})),t}return c(u,[{key:"initCurrentLogFile",value:function(){var e=this;return new Promise((function(n){e.__fileStream=t.createWriteStream(e.config.path,{flags:"a"}),e.config.isRotatingFiles?e.rotateLogFiles().finally((function(){n()})):n()}))}},{key:"rotateLogFiles",value:function(){var n=this;return new Promise((function(o,i){t.readdir(n.config.directory,(function(c,l){if(c)return console.error(c),void i(c);if((l=l.filter((function(e){return e.startsWith(n.config.filePrefix)&&e.endsWith(".log")}))).length<n.config.numberOfFiles)o();else{l=l.sort((function(n,t){return e(n.split(".")[1])-e(t.split(".")[1])}));for(var u=0;u<=l.length-n.config.numberOfFiles;u+=1)try{t.rmSync(r(n.config.directory,l[u]))}catch(e){console.error(e)}o()}}))}))}},{key:"log",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=this.creatingMessage(e,n,t);return r?(this.__fileStream.write("".concat(r,"\n")),r):null}},{key:"formatStoredLogs",value:function(){var e=this;return new Promise((function(n,o){t.readdir(e.config.directory,(function(i,c){if(i)o(i);else try{(c=c.filter((function(n){return n.startsWith(e.config.filePrefix)&&n.endsWith(".log")}))).forEach((function(n){t.rmSync(r(e.config.directory,n))})),n()}catch(e){o(e)}}))})).finally((function(){return e.initCurrentLogFile()}))}}]),u}();var N=function(){function e(){var n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};o(this,e),l(this,"config",null),this.configure(n||{})}return c(e,[{key:"configure",value:function(e){this.config=D({appenders:[],level:process.argv.includes("--debug-mode")?"debug":process.env.D_LOGGER_LOG_LEVEL||process.env.VUE_APP_D_LOGGER_LOG_LEVEL||"debug",template:null},e),0===this.config.appenders.length&&this.config.appenders.push(new T({level:this.config.level})),this.__defineLogMethods()}},{key:"__defineLogMethods",value:function(){var e=this;Object.keys(y).forEach((function(n){e[n]=e.__log(n)}))}},{key:"addFileAppender",value:function(e){var n=arguments.length>1&&void 0!==arguments[1]&&arguments[1],t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:null,i=arguments.length>5&&void 0!==arguments[5]?arguments[5]:5;this.config.appenders.push(new H({level:r||this.config.level,directory:e,filePrefix:t||process.env.VUE_APP_LOG_FILE_PREFIX||"app",template:o||this.config.template,isRotatingFiles:n,stepInStack:i}))}},{key:"addConsoleAppender",value:function(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,n=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],t=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:5;this.config.appenders.push(new T({level:e||this.config.level,colorize:n,template:t||this.config.template,stepInStack:r}))}},{key:"addCustomAppender",value:function(e){return this.config.appenders.push(e)}},{key:"clearAppenders",value:function(){this.config.appenders=[]}},{key:"__log",value:function(e){var n=this;if(!C(e,this.config.level))return function(){for(var e=arguments.length,n=new Array(e),t=0;t<e;t++)n[t]=arguments[t];return n};if(!this.config.appenders||0===this.config.appenders.length)throw new Error("log list appenders is empty");return function(){for(var t=arguments.length,r=new Array(t),o=0;o<t;o++)r[o]=arguments[o];return n.config.appenders.forEach((function(n){return n.log(r,e)}))}}},{key:"getFileAppenders",value:function(){return this.config.appenders.filter((function(e){return e instanceof H}))}},{key:"existFileAppender",value:function(){return this.getFileAppenders().length>0}},{key:"deleteAllFileLogs",value:function(){var e=this.getFileAppenders(),n=[];return e.length>0&&e.forEach((function(e){n.push(e.formatStoredLogs())})),0===n.length?new Promise((function(e){return e()})):Promise.all(n)}},{key:"logProcessEnvs",value:function(){var e="";Object.keys(process.env).forEach((function(n){e+="".concat(n,"=").concat(process.env[n],";\n")})),this.info("Process envs:\n\n".concat(e))}},{key:"dprsObj",value:function(e){for(var n=arguments.length,t=new Array(n>1?n-1:0),r=1;r<n;r++)t[r-1]=arguments[r];return x.apply(void 0,[e].concat(t))}},{key:"dprsValue",value:function(e,n){return Y(e,n)}},{key:"len",value:function(e){return I(e)}}]),e}(),z=new N,J={install:function(e,n){n&&n.logConfig&&z.configure(n.logConfig),e.prototype.$log=z}};export{z as $log,T as ConsoleAppender,N as DLogger,H as FileAppender,V as LogAppender,U as LogMessageInfo,J as default};
